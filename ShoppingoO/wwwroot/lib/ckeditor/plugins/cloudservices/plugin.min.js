CKEDITOR.plugins.add("cloudservices",{requires:"filetools,ajax",onLoad:function(){function e(e,o,r,n){s.call(this,e,o,r),this.customToken=n}var s=CKEDITOR.fileTools.fileLoader;(e.prototype=CKEDITOR.tools.extend({},s.prototype)).upload=function(e,o){(e=e||this.editor.config.cloudServices_uploadUrl)?s.prototype.upload.call(this,e,o):CKEDITOR.error("cloudservices-no-upload-url")},CKEDITOR.plugins.cloudservices.cloudServicesLoader=e},beforeInit:function(o){var e=o.config.cloudServices_tokenUrl,s={token:null,REFRESH_INTERVAL:o.CLOUD_SERVICES_TOKEN_INTERVAL||36e5,refreshToken:function(){CKEDITOR.ajax.load(e,function(e){e&&(s.token=e)})},init:function(){this.refreshToken();var e=window.setInterval(this.refreshToken,this.REFRESH_INTERVAL);o.once("destroy",function(){window.clearInterval(e)})}};e?s.init():CKEDITOR.error("cloudservices-no-token-url"),o.on("fileUploadRequest",function(e){var o=e.data.fileLoader,r=e.data.requestData,n=o.customToken||s.token;o instanceof CKEDITOR.plugins.cloudservices.cloudServicesLoader&&(r.file=r.upload,delete r.upload,n?e.data.fileLoader.xhr.setRequestHeader("Authorization",n):(CKEDITOR.error("cloudservices-no-token"),e.cancel()))},null,null,6),o.on("fileUploadResponse",function(e){var o,r=e.data.fileLoader,n=r.xhr;if(r instanceof CKEDITOR.plugins.cloudservices.cloudServicesLoader){e.stop();try{o=JSON.parse(n.responseText),e.data.response=o}catch(e){CKEDITOR.warn("filetools-response-error",{responseText:n.responseText})}}})}}),CKEDITOR.plugins.cloudservices={cloudServicesLoader:null};